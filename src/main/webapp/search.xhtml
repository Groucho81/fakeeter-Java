<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets">
<ui:composition template="template-nav.xhtml">
	<ui:define name="content">
		<nav class="navbar navbar-inverse">
			<div class="container-fluid">
			    <ul class="nav navbar-nav">
			      <li><h:outputLink rendered="#{authMb.isLogged()}" value="home.xhtml">Tus Mensajes</h:outputLink></li>
			      <li><h:outputLink rendered="#{authMb.isLogged()}" value="following.xhtml">Siguiendo</h:outputLink></li>
			      <li><a href="allPosts.xhtml">Todos los Mensajes</a></li>
			    </ul>
			    <h:panelGroup rendered="#{authMb.isLogged()}" styleClass="navbar-form navbar-left">
			    	<button type="button" class="btn btn-info" data-toggle="modal" data-target="#postModal">Crear Post</button>
			    </h:panelGroup>
			    <h:panelGroup rendered="#{authMb.isLogged()}">
				    <ul class="nav navbar-nav navbar-right">
				    	<li><a href="#" data-toggle="modal" data-target="#avatarModal">Edita tu perfil</a></li>
				    	<li class="active"><a href="#" data-toggle="modal" data-target="#searchUserModal">Buscar Usuario</a></li>
	      				<h:form styleClass="navbar-form navbar-right">
	                		<h:commandLink action="#{authMb.logout()}" rendered="#{authMb.isLogged()}" styleClass="btn btn-info"><span class="glyphicon glyphicon-log-out glyphSpace"></span>Deslogueate</h:commandLink>
						</h:form>
	    			</ul>
    			</h:panelGroup>
    			<h:panelGroup rendered="#{!authMb.isLogged()}">
    				<ul class="nav navbar-nav navbar-right">
				    	<li><a href="index.xhtml">Logueate</a></li>
				    	<li><a href="register.xhtml">Registrate</a></li>
	    			</ul>
    			</h:panelGroup>
			</div>
		</nav>
		<!-- Modals -->
		<!-- Modal to create post -->
		<div id="postModal" class="modal fade" role="dialog">
  			<div class="modal-dialog">
		    <!-- Modal content-->
    			<div class="modal-content">
      				<div class="modal-header">
        				<button type="button" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
        				<h4 class="modal-title">Envia un post con imagen</h4>
      				</div>
      				<div class="modal-body">
				        <h:form enctype="multipart/form-data">
							<div class="form-group">
								<label>Mensaje</label>
								<h:inputText maxlength="140" styleClass="form-control" value="#{homeMb.post}"></h:inputText>
							</div>
							<div class="form-group">
								<label>Imagen</label>
								<h:inputFile id="filePost" value="#{homeMb.file}"/>
							</div>
							<h:commandButton action="#{homeMb.send()}" value="Enviar" styleClass="btn btn-success">
					        </h:commandButton>
						</h:form>
      				</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					</div>
    			</div>
			</div>
		</div>
		<!-- Modal to change profile -->
		<div id="avatarModal" class="modal fade" role="dialog">
  			<div class="modal-dialog">
		    <!-- Modal content-->
    			<div class="modal-content">
      				<div class="modal-header">
        				<button type="button" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
        				<h4 class="modal-title">Editar Perfil</h4>
      				</div>
      				<div class="modal-body">
				        <h:form enctype="multipart/form-data">
				        	<div class="form-group">
								<label>Password</label>
								<h:inputSecret id="password_form" styleClass="form-control" value="#{homeMb.password}" label="Password"></h:inputSecret>
							</div>
							<div class="form-group">
								<label>Elegi una imagen de perfil</label>
								<h:inputFile id="fileAvatar" value="#{homeMb.file}"/>
							</div>
							<h:commandButton action="#{homeMb.changeProfile()}" value="Enviar" styleClass="btn btn-success">
									<!--  <f:ajax render="postList avatarModal" execute="@form"></f:ajax> -->
					        </h:commandButton>	
						</h:form>
      				</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					</div>
    			</div>
			</div>
		</div>
		<!-- Modal search User -->
		<div id="searchUserModal" class="modal fade" role="dialog">
  			<div class="modal-dialog">
		    <!-- Modal content-->
    			<div class="modal-content">
      				<div class="modal-header">
        				<button type="button" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span></button>
        				<h4 class="modal-title">Busca un usuario</h4>
      				</div>
      				<div class="modal-body">
				        <h:form enctype="multipart/form-data" styleClass="form-inline">
							<div class="form-group">
								<label class="glyphSpace">Nombre de Usuario</label>
								<h:inputText styleClass="form-control glyphSpace" id="nombreUsuario" value="#{search.searchValue}"></h:inputText>
							</div>
							<h:commandButton action="#{search.searchUsers()}" value="Buscar" styleClass="btn btn-success">
									<f:ajax render="@form" execute="@form"></f:ajax>
					        </h:commandButton>
							<hr></hr>
							<h:panelGroup id="searchResult">
	      						<h:dataTable styleClass="table table-hover" value="#{search.searchResult}" var="u">
									<h:column>
										<f:facet name="header">Usuario</f:facet>
										#{u.userName}
									</h:column>
									<h:column>
										<f:facet name="header">Email</f:facet>
										#{u.email}
									</h:column>
									<h:column>						
										<h:outputLink styleClass="btn btn-primary" value="search.xhtml?uid=#{u.id}">Ver sus posteos</h:outputLink>
									</h:column>
									<h:column>
										<h:form>
											<h:commandLink action="#{followerMb.follow(u)}" styleClass="btn btn-primary #{followerMb.canFollow(u)}"><span class="glyphicon glyphicon-hand-right glyphSpace"></span>
												Seguir
											</h:commandLink>
										</h:form>
									</h:column>
								</h:dataTable>
							</h:panelGroup>
						</h:form>
      				</div>      				
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					</div>
    			</div>
			</div>
		</div>
		<!-- End of Modals -->
		<div class="row">
			<div class="col-md-3">
				<h:messages id="registry_errors" globalOnly="false" layout="table" errorClass="alert alert-danger" />
			</div>
			<div class="col-md-6" >
				<h:panelGroup id="postList">
				<ui:repeat var="p" value="#{search.userPosts}" id="post_list" >
					<div class="media post">
						<div class="media-left">
							<h:panelGroup rendered="#{p.user.avatar.path eq null}">
								<img src="resources/images/img_avatar2.png" class="media-object" style="width:80px"/>
							</h:panelGroup>
							<h:panelGroup rendered="#{p.user.avatar.path ne null}">
								<img src="/img/#{p.user.avatar.path}" class="media-object" style="width:80px"/>
							</h:panelGroup>
							<h:panelGroup>
								<br></br>
								<h:form>
									<h:commandLink action="#{followerMb.follow(p.user)}" styleClass="btn btn-primary #{followerMb.canFollow(p.user)}"><span class="glyphicon glyphicon-hand-right glyphSpace"></span>Seguir
										<f:ajax render="@form"></f:ajax>
									</h:commandLink>
								</h:form>
							</h:panelGroup>
						</div>
						<div class="media-body">
							<h4 class="media-heading">
								<h:outputText value="#{p.userName} " />
								<small>Fecha: <h:outputText value="#{p.date}" /></small>
							</h4>
							<h:panelGroup rendered="#{p.image ne null}">
								<div class="thumbnail">
	        						<img src="/img/#{p.image.path}" class="img-responsive" alt="Imagen del Post"></img>
								</div>
								<p>#{p.post}</p>
							</h:panelGroup>
							<h:panelGroup rendered="#{p.image eq null}">
								<p>#{p.post}</p>
							</h:panelGroup>
							<h:form>
								<label>Me Gusta (#{likesMb.likeCount(p)}) : </label>
								<h:commandLink action="#{likesMb.like(p)}" styleClass="btn btn-primary #{likesMb.isLikable(p)}"><span class="glyphicon glyphicon-thumbs-up"></span>
									<f:ajax render="@form"></f:ajax>
								</h:commandLink>
							</h:form>
							<span class="label label-default">Comentarios:</span>
							<h:form id="comment_form">
								<div class="form-group">
									<h:panelGroup id="comment_list">
										<ui:repeat var="comment" value="#{commentMb.listByPost(p)}">
											<div class="media">
												<div class="media-body">
													<h4 class="media-heading">
														<h:outputText value="#{comment.user.userName}" />
														<small>Fecha: 
															<h:outputText value="#{comment.date}" >
																<f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
															</h:outputText>
														</small>
													</h4>
													<h:outputText value="#{comment.content}" />
												</div>
												<div class="media-right">
													<h:panelGroup rendered="#{comment.user.avatar.path ne null}">
														<img src="/img/#{comment.user.avatar.path}" class="media-object" style="width:60px"/>
													</h:panelGroup>
													<h:panelGroup rendered="#{comment.user.avatar.path eq null}">
														<img src="resources/images/img_avatar2.png" class="media-object" style="width:60px"/>
													</h:panelGroup>
												</div>							
											</div>
										</ui:repeat>
									</h:panelGroup>
								</div>
								<h:panelGroup rendered="#{authMb.isLogged()}">
									<div class="form-group" rendered="#{authMb.isLogged()}">							
											<h:inputText value="#{commentMb.comment}" styleClass="form-control mybuttons commentInput" />
											<h:commandButton styleClass="btn btn-primary mybuttons" action="#{commentMb.create(p)}" value="Comentar" >
												<f:ajax render="comment_list" execute="@form"></f:ajax>
											</h:commandButton>
									</div>
								</h:panelGroup>
							</h:form>
						</div>
					</div>
  				</ui:repeat>
  				</h:panelGroup>			
			</div>
		</div>
		<div class="col-md-3"></div>
	</ui:define>
</ui:composition>
</html>